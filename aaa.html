<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D3.js 分组柱状图</title>
<script src="https://d3js.org/d3.v7.min.js"></script> 
<style>
body {
    font-family: 'Arial', sans-serif;
    background-color: #f0f0f0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
svg {
    background: white;
    border: 1px solid #ccc;
}
.axis-label {
    font-size: 14px;
    font-weight: bold;
}
.tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    pointer-events: none;
    font-size: 12px;
}
.legend rect {
    fill: white;
    stroke: #333;
    stroke-width: 1;
}
</style>
</head>
<body>

<div id="chart"></div>

<script>
// 定义更多数据
const data = [
    { year: "2010", country: "美国", gdp: 14.99 },
    { year: "2010", country: "中国", gdp: 6.04 },
    { year: "2010", country: "日本", gdp: 5.77 },
    { year: "2011", country: "美国", gdp: 15.52 },
    { year: "2011", country: "中国", gdp: 7.32 },
    { year: "2011", country: "日本", gdp: 6.23 },
    { year: "2012", country: "美国", gdp: 16.17 },
    { year: "2012", country: "中国", gdp: 8.35 },
    { year: "2012", country: "日本", gdp: 6.20 },
    { year: "2013", country: "美国", gdp: 16.67 },
    { year: "2013", country: "中国", gdp: 9.24 },
    { year: "2013", country: "日本", gdp: 4.89 },
    { year: "2014", country: "美国", gdp: 17.42 },
    { year: "2014", country: "中国", gdp: 10.48 },
    { year: "2014", country: "日本", gdp: 4.61 },
    // 更多年份和国家的数据...
];

// 设置图表的尺寸和边距
const margin = { top: 40, right: 30, bottom: 60, left: 80 };
const width = 960 - margin.left - margin.right;
const height = 500 - margin.top - margin.bottom;

// 在 chart div 中添加 SVG
const svg = d3.select("#chart")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// 提取唯一的年份和国家
const years = [...new Set(data.map(d => d.year))];
const countries = [...new Set(data.map(d => d.country))];

// 定义比例尺
const x0 = d3.scaleBand()
    .domain(years)
    .range([0, width])
    .padding(0.1);

const x1 = d3.scaleBand()
    .domain(countries)
    .range([0, x0.bandwidth()])
    .padding(0.05);

const y = d3.scaleLinear()
    .domain([0, d3.max(data, d => d.gdp)])
    .nice()
    .range([height, 0]);

const color = d3.scaleOrdinal()
    .domain(countries)
    .range(["#4CAF50", "#2196F3", "#FF5722"]);

// 添加 X 轴
svg.append("g")
    .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(x0))
    .selectAll("text")
    .attr("class", "axis-label")
    .style("text-anchor", "middle");

// 添加 Y 轴
svg.append("g")
    .call(d3.axisLeft(y).ticks(5))
    .selectAll("text")
    .attr("class", "axis-label");

// 添加网格线
svg.append("g")
    .attr("class", "grid")
    .call(d3.axisLeft(y)
        .tickSize(-width)
        .tickFormat(""))
    .select(".domain").remove();

// 工具提示
const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

// 绘制柱状图
svg.selectAll("g.bar-group")
    .data(data)
    .enter()
    .append("g")
    .attr("transform", d => `translate(${x0(d.year)},0)`)
    .selectAll("rect")
    .data(d => countries.map(country => ({
        country,
        year: d.year,
        gdp: data.find(e => e.year === d.year && e.country === country)?.gdp
    })))
    .enter()
    .append("rect")
    .attr("x", d => x1(d.country))
    .attr("y", d => y(d.gdp))
    .attr("width", x1.bandwidth())
    .attr("height", d => height - y(d.gdp))
    .attr("fill", d => color(d.country))
    .on("mouseover", function(event, d) {
        tooltip.transition().duration(200).style("opacity", 1);
        tooltip.html(`年份: ${d.year}<br>国家: ${d.country}<br>GDP: ${d.gdp} 万亿美元`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function() {
        tooltip.transition().duration(200).style("opacity", 0);
    })
    .on("click", function(event, d) {
        alert(`年份: ${d.year}, 国家: ${d.country}, GDP: ${d.gdp} 万亿美元`);
    });

// 添加图例
const legend = svg.append("g")
    .attr("class", "legend")
    .attr("transform", `translate(${width - 200}, ${height - 40})`)
    .style("font-size", "12px");

legend.selectAll("rect")
    .data(countries)
    .enter()
    .append("rect")
    .attr("x", width - 200)
    .attr("y", (d, i) => i * 20)
    .attr("width", 15)
    .attr("height", 15)
    .attr("fill", color);

legend.selectAll("text")
    .data(countries)
    .enter()
    .append("text")
    .attr("x", width - 180)
    .attr("y", (d, i) => i * 20 + 10)
    .text(d => d);
</script>
</body>
</html>
